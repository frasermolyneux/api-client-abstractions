name: Main Branch Build and Tag

on:
  workflow_dispatch:
  push:
    branches:
      - main
    #paths:
    #  - 'src/**'

permissions:
  contents: read

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.gitversion.outputs.SemVer }}
      nuget_version: ${{ steps.gitversion.outputs.SemVer }}
      tag_name: ${{ steps.release_tag.outputs.tag_name }}
      should_tag: ${{ steps.release_tag.outputs.should_tag }}

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup GitVersion
      uses: gittools/actions/gitversion/setup@v4
      with:
        versionSpec: '6.4.x'

    - name: Determine version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4

    - name: Decide tag requirement
      id: release_tag
      shell: pwsh
      env:
        SEMVER: ${{ steps.gitversion.outputs.SemVer }}
      run: |
        git fetch --tags --force
        $existing = git tag --points-at HEAD | Where-Object { $_ -like 'v*' } | Select-Object -First 1
        if ($existing) {
          Write-Host "HEAD already tagged with $existing; skipping tag creation."
          "should_tag=false" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag_name=$existing" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          exit 0
        }

        $tagName = "v$Env:SEMVER"
        Write-Host "Next release tag: $tagName"
        "should_tag=true" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
        "tag_name=$tagName" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

  dotnet-ci:
    needs: calculate-version
    runs-on: ubuntu-latest
    env:
      BUILD_VERSION_OVERRIDE: ${{ needs.calculate-version.outputs.nuget_version }}

    steps:
    - uses: actions/checkout@v6

    - uses: frasermolyneux/actions/dotnet-ci@main
      with:
        dotnet-version: |
          9.0.x
          10.0.x-preview
        src-folder: "src"
        majorMinorVersion: "0.0"

  tag-release:
    needs:
      - calculate-version
      - dotnet-ci
    if: needs.calculate-version.outputs.should_tag == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Create tag
      shell: pwsh
      run: |
        git tag ${{ needs.calculate-version.outputs.tag_name }}

    - name: Push tag
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
      run: |
        git push origin ${{ needs.calculate-version.outputs.tag_name }}
