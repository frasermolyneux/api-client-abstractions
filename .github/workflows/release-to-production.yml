name: Release to Production

on:
  workflow_run:
    workflows:
      - Main Branch Build and Tag
    types:
      - completed

permissions:
  contents: read  # Required for checkout/tag inspection
  actions: read   # Required to download artifacts from another workflow run

jobs:
  publish-nuget-packages:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: NuGet
    runs-on: ubuntu-latest
    env:
      HAS_RELEASE_TAG: 'false'

    steps:
    - name: Checkout tagged commit
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    - name: Detect release tag on commit
      shell: pwsh
      run: |
        git fetch --tags --force
        $tags = git tag --points-at HEAD | Where-Object { $_ -like 'v*' }
        if (-not $tags) {
          Write-Host "No release-tag (v*) found on commit ${{ github.event.workflow_run.head_sha }}. Skipping publish."
          exit 0
        }

        $selected = ($tags | Sort-Object)[0]
        Write-Host "Found release tag '$selected'. Preparing publish."
        "HAS_RELEASE_TAG=true" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
        "RELEASE_TAG=$selected" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

    - name: Download NuGet packages
      if: env.HAS_RELEASE_TAG == 'true'
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path: nuget-packages

    - name: Publish to NuGet.org
      if: env.HAS_RELEASE_TAG == 'true'
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      shell: bash
      run: |
        cd nuget-packages
        dotnet nuget push **/*.nupkg --source 'https://api.nuget.org/v3/index.json' --api-key "$NUGET_API_KEY"
          