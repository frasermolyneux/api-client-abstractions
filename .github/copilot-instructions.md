# Copilot Instructions

- **Purpose & layout**: .NET 9/10 library set under `src/` providing shared API response models (`MX.Api.Abstractions`), a RestSharp + Polly client stack (`MX.Api.Client`), ASP.NET Core helpers (`MX.Api.Web.Extensions`), and tests in sibling `*.Tests` projects. Packaging/versioning driven by `version.json` with Nerdbank.GitVersioning; solution entry is `src/MX.Api.Abstractions.sln`.
- **Build & test**: `dotnet build src/MX.Api.Abstractions.sln` then `dotnet test src/MX.Api.Abstractions.sln --filter "FullyQualifiedName!~IntegrationTests"` for unit coverage; integration tests live in `MX.Api.IntegrationTests` and require external services/auth.
- **Key workflows**: Workflows in `.github/workflows/` â€” `build-and-test.yml` (feature/bugfix/hotfix pushes), `pr-verify.yml` (PR gate), `codequality.yml` (SonarCloud + CodeQL), `release-version-and-tag.yml` then `release-publish-nuget.yml` for NuGet releases, plus `dependabot-automerge.yml` and `copilot-setup-steps.yml`.
- **Client registration pattern**: Prefer DI helpers in `MX.Api.Client.Extensions.ApiClientExtensions`. Typical usage: `services.AddApiClient<IMyClient, MyClient>(opts => opts.WithBaseUrl(...) .WithApiKeyAuthentication(...) .WithEntraIdAuthentication("api://audience"));` The builder persists options as singletons; clients are constructed with `BaseApi<TOptions>` dependencies (logger, optional `IApiTokenProvider`, `IRestClientService`, options). Entra ID authentication requires `IApiTokenProvider`, wired automatically when any `EntraIdAuthenticationOptions` are configured.
- **Execution pipeline**: `BaseApi<TOptions>` validates options, applies multiple auth schemes per request (API key headers + Entra ID bearer), and executes via `IRestClientService` with a Polly exponential backoff retry policy; success codes considered include 200/201/204/404, others throw `HttpRequestException`. Request creation uses `CreateRequestAsync` to attach auth up front.
- **Options & auth**: Authentication choices live under `MX.Api.Client.Configuration` (`ApiKeyAuthenticationOptions`, `EntraIdAuthenticationOptions`, `AzureCredentialAuthenticationOptions`, `ClientCredentialAuthenticationOptions`). Token acquisition uses `ApiTokenProvider` with credential providers in `Auth/`; APIs can mix API key + Entra ID on the same request.
- **Response handling**: Consumers typically call `ExecuteAsync` then map with extension helpers in `Extensions/RestResponseExtensions.cs` and `Extensions/RequestExtensions.cs` to `ApiResponse<T>` / `ApiResult<T>` (from `MX.Api.Abstractions`). Keep error handling consistent with these wrappers.
- **Web helpers**: `MX.Api.Web.Extensions` contains ASP.NET Core extensions to translate API results into `IActionResult` responses; use when building providers to match the shared envelope conventions.
- **Docs**: High-level patterns are documented in `docs/` (API design, provider/consumer guidance, versioned clients, package maintenance, dotnet support, workflows). Align code changes with these references and update docs if behaviors diverge.
- **Testing notes**: Multi-targeting `net9.0;net10.0` is enforced; when adding dependencies consider conditional references for ASP.NET test packages. Integration tests should be filtered out by default; include them explicitly when required.
